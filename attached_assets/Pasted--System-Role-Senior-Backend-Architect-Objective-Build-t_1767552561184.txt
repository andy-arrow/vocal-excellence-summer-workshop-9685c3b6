@System Role: Senior Backend Architect
@Objective: Build the "Market Scanner" Service (Strategy A) - High-End Capable & Rate-Limited
@Context: We are building the valuation engine for "Cash My Piano." We will use the eBay Browse API to fetch ACTIVE listings. We must handle high-value items (up to €250k) and strictly adhere to the 5,000 calls/day limit via caching.

@STEP 1: INSTALL DEPENDENCIES
Run: `npm install axios qs node-cache`

@STEP 2: CREATE THE EBAY SERVICE (server/services/ebay.ts)
Create `server/services/ebay.ts` exporting class `EbayService`.

1. `constructor()`:
   - Initialize `NodeCache` with a TTL of 1 Hour (3600 seconds).

2. `getAccessToken()`:
   - Endpoint: `https://api.ebay.com/identity/v1/oauth2/token`
   - Headers: `Authorization: Basic <Base64(CLIENT_ID:CLIENT_SECRET)>`, `Content-Type: application/x-www-form-urlencoded`
   - Body: `grant_type=client_credentials&scope=https://api.ebay.com/oauth/api_scope/buy.browse`
   - Logic: Cache the token. Check `expires_in` before use.

3. `searchActivePianos(query: string)`:
   - CACHE KEY NORMALIZATION: `const cacheKey = query.toLowerCase().trim();`
   - CACHE CHECK: If `this.cache.get(cacheKey)` exists, return it.
   - Endpoint: `https://api.ebay.com/buy/browse/v1/item_summary/search`
   - Headers: `Authorization: Bearer <TOKEN>`, `X-EBAY-C-MARKETPLACE-ID: EBAY-DE`
   - Params:
     - `q`: `query`
     - `category_ids`: `43376`
     - `limit`: `20`
     - `sort`: `price`
     - `filter`: `price:[1000..250000],priceCurrency:EUR,conditionIds:{3000|4000|5000|2000|2500},buyingOptions:{FIXED_PRICE|BEST_OFFER}`
   - Success: Store result in Cache for 1 hour. Return result.
   - Error: Return null.

4. `calculateMarketValue(listings: any[])`:
   - Filter Logic: Exclude "Digital", "Silent", "Cover", "Bench", "Transport", "Miete" (Rental).
   - High-End Logic:
     - If query matches /Steinway|Bösendorfer|Fazioli|Bechstein/i:
       - Take Average of Median 5 listings (Discard cheapest outliers).
     - Else:
       - Take Average of Lowest 5 listings.
   - Formula: `EstimatedValue = AveragePrice * 0.836`
   - Return: `{ estimatedValue, activeCount, currency: "EUR", strategy: "High-End" | "Mass-Market" }`

@STEP 3: INTEGRATE WITH VALUATION ROUTE (server/routes.ts)
Update `/api/valuation`:
- Call `ebayService.searchActivePianos(model)`.
- If valid data returns:
  - Override base `mathValue`.
  - Set `confidenceScore` to "High".
  - Add `marketSource`: "eBay Active Market (Cached)" or "eBay Active Market (Live)".
- If no data: Fallback to S-Curve.

@STEP 4: SECRETS
Code must read `process.env.EBAY_APP_ID` and `process.env.EBAY_CERT_ID`.

@EXECUTE:
Implement now. Ensure strict comma separation in filter string: `price:[],priceCurrency:EUR,conditionIds:{}`.
